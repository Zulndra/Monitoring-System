name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://98.87.83.12
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Backup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            # Create backup directory
            BACKUP_DIR="../backups/$(date +%Y%m%d_%H%M%S)"
            mkdir -p $BACKUP_DIR
            cp -r . $BACKUP_DIR
            
            echo "âœ… Backup created at $BACKUP_DIR"

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            # Pull latest changes
            git fetch origin
            git checkout main
            git pull origin main
            
            # Restart services
            sudo docker compose down
            sudo docker compose pull
            sudo docker compose up -d
            
            echo "âœ… Production deployment completed!"

- name: Health Check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            
            cd ${{ secrets.PROJECT_PATH }}
            
            echo "ðŸ¥ Starting comprehensive health check..."
            echo ""
            
            # 1. Check container status
            echo "ðŸ“¦ Checking container status..."
            CONTAINERS=$(docker compose ps --format json)
            RUNNING=$(echo "$CONTAINERS" | grep -c '"State":"running"' || echo "0")
            TOTAL=$(echo "$CONTAINERS" | wc -l)
            
            echo "   Running: $RUNNING/$TOTAL containers"
            
            if [ "$RUNNING" -eq 0 ]; then
              echo "   âŒ No containers running!"
              docker compose ps
              exit 1
            fi
            
            echo ""
            
            # 2. Check for errors in logs (last 50 lines)
            echo "ðŸ“‹ Checking for critical errors in logs..."
            ERROR_COUNT=$(docker compose logs --tail=50 2>&1 | grep -iE "error|fatal|panic|critical" | grep -v "level=info" | wc -l || echo "0")
            
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "   âš ï¸  Found $ERROR_COUNT error messages in logs"
              echo "   Recent errors:"
              docker compose logs --tail=50 2>&1 | grep -iE "error|fatal|panic" | tail -5
            else
              echo "   âœ… No critical errors in recent logs"
            fi
            
            echo ""
            
            # 3. Wait for services to be ready
            echo "â³ Waiting for services to be ready (30s)..."
            sleep 30
            
            # 4. Check Grafana
            echo "ðŸ” Checking Grafana..."
            if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health | grep -q "200"; then
              echo "   âœ… Grafana is healthy (HTTP 200)"
            else
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health || echo "000")
              echo "   âŒ Grafana health check failed (HTTP $HTTP_CODE)"
            fi
            
            # 5. Check Prometheus
            echo "ðŸ” Checking Prometheus..."
            if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:9090/-/healthy | grep -q "200"; then
              echo "   âœ… Prometheus is healthy (HTTP 200)"
            else
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9090/-/healthy || echo "000")
              echo "   âŒ Prometheus health check failed (HTTP $HTTP_CODE)"
            fi
            
            # 6. Check SNMP Exporter
            echo "ðŸ” Checking SNMP Exporter..."
            if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:9116/metrics | grep -q "200"; then
              echo "   âœ… SNMP Exporter is healthy (HTTP 200)"
            else
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9116/metrics || echo "000")
              echo "   âŒ SNMP Exporter health check failed (HTTP $HTTP_CODE)"
            fi
            
            echo ""
            
            # 7. Check resource usage
            echo "ðŸ’» Checking resource usage..."
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" | head -10
            
            echo ""
            
            # 8. Final summary
            echo "ðŸ“Š Deployment Health Summary:"
            echo "   â€¢ Containers: $RUNNING/$TOTAL running"
            echo "   â€¢ Grafana: $(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health || echo "DOWN")"
            echo "   â€¢ Prometheus: $(curl -s -o /dev/null -w "%{http_code}" http://localhost:9090/-/healthy || echo "DOWN")"
            echo "   â€¢ SNMP Exporter: $(curl -s -o /dev/null -w "%{http_code}" http://localhost:9116/metrics || echo "DOWN")"
            
            echo ""
            echo "âœ… Health check completed!"

      - name: Send Notification
        if: always()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            if [ ${{ job.status }} == 'success' ]; then
              echo "ðŸŽ‰ Production deployment successful and healthy!"
            else
              echo "âŒ Production deployment failed or unhealthy!"
              echo "ðŸ“‹ Last 30 lines of logs:"
              docker compose logs --tail=30
            fi

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Production Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: 98.87.83.12" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup**: Created âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
